name: Sync Local Wiki to GitHub Wiki

on:
  push:
    branches: [ main, master ]
    paths:
      - '.qoder/repowiki/zh/content/**'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå¿½ç•¥æ˜¯å¦æœ‰æ›´æ”¹ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Wiki Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}.wiki
        path: wiki-repo
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Check Local Wiki Directory
      run: |
        if [ -d ".qoder/repowiki/zh/content" ]; then
          echo "âœ… æ‰¾åˆ°Qoder wikiå†…å®¹ç›®å½•: .qoder/repowiki/zh/content"
          echo "ðŸ“ ç›®å½•å†…å®¹:"
          ls -la .qoder/repowiki/zh/content/
        else
          echo "âŒ æœªæ‰¾åˆ°.qoder/repowiki/zh/contentç›®å½•"
          echo "è¯·åœ¨Qoder IDEä¸­åˆ›å»ºwikiå†…å®¹"
          exit 1
        fi

    - name: Sync Local Wiki to GitHub Wiki
      run: |
        mkdir -p wiki-repo
        
        find wiki-repo -mindepth 1 -name ".git" -prune -o -type f -delete
        
        if [ -d ".qoder/repowiki/zh/content" ]; then
          cp -r .qoder/repowiki/zh/content/* wiki-repo/ 2>/dev/null || true
          echo "âœ… å·²å°†.qoder/repowiki/zh/contentç›®å½•å†…å®¹å¤åˆ¶åˆ°GitHub Wiki"
          
          echo "ðŸ“„ åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨:"
          find wiki-repo -name "*.md" -type f | while read file; do
            echo "  - $(basename "$file")"
          done
        else
          echo "âŒ .qoder/repowiki/zh/contentç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•åŒæ­¥"
          exit 1
        fi

    - name: Commit and Push Wiki Changes
      run: |
        cd wiki-repo
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .
        
        if git diff --staged --quiet; then
          if [ "${{ github.event.inputs.force_sync }}" = "true" ]; then
            echo "ðŸ”„ å¼ºåˆ¶åŒæ­¥æ¨¡å¼ï¼šå³ä½¿æ²¡æœ‰æ›´æ”¹ä¹Ÿåˆ›å»ºæäº¤"
            echo "ðŸ“š å¼ºåˆ¶åŒæ­¥wikiå†…å®¹ - $(date '+%Y-%m-%d %H:%M:%S')" > commit_message.txt
            echo "" >> commit_message.txt
            echo "å¼ºåˆ¶åŒæ­¥æ‰§è¡Œ" >> commit_message.txt
            git commit --allow-empty -F commit_message.txt
            git push
            echo "âœ… Wikiå†…å®¹å·²å¼ºåˆ¶åŒæ­¥åˆ°GitHub Wikiï¼"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œæ— éœ€æäº¤"
          fi
        else
          echo "ðŸ“š ä»Ž.qoder/repowikiåŒæ­¥wikiå†…å®¹ - $(date '+%Y-%m-%d %H:%M:%S')" > commit_message.txt
          echo "" >> commit_message.txt
          echo "åŒæ­¥çš„æ–‡ä»¶:" >> commit_message.txt
          git status --porcelain | sed 's/^/- /' >> commit_message.txt
          
          git commit -F commit_message.txt
          git push
          echo "âœ… Wikiå†…å®¹å·²æˆåŠŸåŒæ­¥åˆ°GitHub Wikiï¼"
        fi

    - name: Create Summary
      run: |
        echo "## ðŸŽ¯ WikiåŒæ­¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **æºç›®å½•**: .qoder/repowiki/zh/content" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡**: GitHub Wiki" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d ".qoder/repowiki/zh/content" ]; then
          file_count=$(find .qoder/repowiki/zh/content -name "*.md" -type f | wc -l)
          echo "- **åŒæ­¥æ–‡ä»¶æ•°é‡**: $file_count" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ åŒæ­¥çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          find .qoder/repowiki/zh/content -name "*.md" -type f | while read file; do
            filename=$(basename "$file")
            echo "- $filename" >> $GITHUB_STEP_SUMMARY
          done
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— è®¿é—®é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "[ðŸ“– æŸ¥çœ‹GitHub Wiki](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY