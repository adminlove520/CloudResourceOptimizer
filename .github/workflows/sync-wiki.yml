name: Sync Local Wiki to GitHub Wiki

on:
  push:
    branches: [ main, master ]
    paths:
      - '.qoder/repowiki/**'
  workflow_dispatch:

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Wiki Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}.wiki
        path: wiki-repo
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Check Local Wiki Directory
      run: |
        if [ -d ".qoder/repowiki" ]; then
          echo "âœ… æ‰¾åˆ°æœ¬åœ°wikiç›®å½•: .qoder/repowiki"
          echo "ðŸ“ ç›®å½•å†…å®¹:"
          ls -la .qoder/repowiki/
        else
          echo "âŒ æœªæ‰¾åˆ°.qoder/repowikiç›®å½•"
          echo "åˆ›å»ºç¤ºä¾‹wikiç›®å½•..."
          mkdir -p .qoder/repowiki
          
          # åˆ›å»ºç¤ºä¾‹Homeé¡µé¢
          cat > .qoder/repowiki/Home.md << 'EOF'
# CloudResourceOptimizer

æ¬¢è¿Žä½¿ç”¨CloudResourceOptimizerï¼è¿™æ˜¯ä»Ž.qoder/repowikiç›®å½•åŒæ­¥çš„wikiå†…å®¹ã€‚

## å¿«é€Ÿå¯¼èˆª
- [é¡¹ç›®æ¦‚è¿°](Project-Overview)
- [ä½¿ç”¨æŒ‡å—](Usage-Guide)
- [APIæ–‡æ¡£](API-Documentation)
- [é…ç½®æŒ‡å—](Configuration-Guide)
EOF
        fi

    - name: Sync Local Wiki to GitHub Wiki
      run: |
        # ç¡®ä¿wikiä»“åº“ç›®å½•å­˜åœ¨
        mkdir -p wiki-repo
        
        # æ¸…ç©ºwikiä»“åº“å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•ï¼‰
        find wiki-repo -mindepth 1 -name ".git" -prune -o -type f -delete
        
        # å¤åˆ¶.qoder/repowikiç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹åˆ°wikiä»“åº“
        if [ -d ".qoder/repowiki" ]; then
          cp -r .qoder/repowiki/* wiki-repo/ 2>/dev/null || true
          echo "âœ… å·²å°†.qoder/repowikiç›®å½•å†…å®¹å¤åˆ¶åˆ°GitHub Wiki"
          
          # æ˜¾ç¤ºå¤åˆ¶çš„æ–‡ä»¶
          echo "ðŸ“„ åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨:"
          find wiki-repo -name "*.md" -type f | while read file; do
            echo "  - $(basename "$file")"
          done
        else
          echo "âŒ .qoder/repowikiç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•åŒæ­¥"
          exit 1
        fi

    - name: Commit and Push Wiki Changes
      run: |
        cd wiki-repo
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œæ— éœ€æäº¤"
        else
          # ç”Ÿæˆæäº¤ä¿¡æ¯ï¼ŒåŒ…å«æ›´æ”¹æ–‡ä»¶åˆ—è¡¨
          echo "ðŸ“š ä»Ž.qoder/repowikiåŒæ­¥wikiå†…å®¹ - $(date '+%Y-%m-%d %H:%M:%S')" > commit_message.txt
          echo "" >> commit_message.txt
          echo "åŒæ­¥çš„æ–‡ä»¶:" >> commit_message.txt
          git status --porcelain | sed 's/^/- /' >> commit_message.txt
          
          git commit -F commit_message.txt
          git push
          echo "âœ… Wikiå†…å®¹å·²æˆåŠŸåŒæ­¥åˆ°GitHub Wikiï¼"
        fi

    - name: Create Summary
      run: |
        echo "## ðŸŽ¯ WikiåŒæ­¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **æºç›®å½•**: .qoder/repowiki" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡**: GitHub Wiki" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d ".qoder/repowiki" ]; then
          file_count=$(find .qoder/repowiki -name "*.md" -type f | wc -l)
          echo "- **åŒæ­¥æ–‡ä»¶æ•°é‡**: $file_count" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ åŒæ­¥çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          find .qoder/repowiki -name "*.md" -type f | while read file; do
            filename=$(basename "$file")
            echo "- $filename" >> $GITHUB_STEP_SUMMARY
          done
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— è®¿é—®é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "[ðŸ“– æŸ¥çœ‹GitHub Wiki](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY