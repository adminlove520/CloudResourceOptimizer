name: Sync Local Wiki to GitHub Wiki

on:
  push:
    branches: [ main, master ]
    paths:
      - '.qoder/repowiki/zh/content/**'
  workflow_dispatch:
    inputs:
      force_sync:
        description: '强制同步（忽略是否有更改）'
        required: false
        default: false
        type: boolean

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Wiki Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}.wiki
        path: wiki-repo
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Check Local Wiki Directory
      run: |
        if [ -d ".qoder/repowiki/zh/content" ]; then
          echo "✅ 找到Qoder wiki内容目录: .qoder/repowiki/zh/content"
          echo "📁 目录内容:"
          ls -la .qoder/repowiki/zh/content/
        else
          echo "❌ 未找到.qoder/repowiki/zh/content目录"
          echo "请在Qoder IDE中创建wiki内容"
          exit 1
        fi

    - name: Sync Local Wiki to GitHub Wiki
      run: |
        mkdir -p wiki-repo
        
        find wiki-repo -mindepth 1 -name ".git" -prune -o -type f -delete
        
        if [ -d ".qoder/repowiki/zh/content" ]; then
          cp -r .qoder/repowiki/zh/content/* wiki-repo/ 2>/dev/null || true
          echo "✅ 已将.qoder/repowiki/zh/content目录内容复制到GitHub Wiki"
          
          echo "📄 同步的文件列表:"
          find wiki-repo -name "*.md" -type f | while read file; do
            echo "  - $(basename "$file")"
          done
        else
          echo "❌ .qoder/repowiki/zh/content目录不存在，无法同步"
          exit 1
        fi

    - name: Commit and Push Wiki Changes
      run: |
        cd wiki-repo
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .
        
        if git diff --staged --quiet; then
          if [ "${{ github.event.inputs.force_sync }}" = "true" ]; then
            echo "🔄 强制同步模式：即使没有更改也创建提交"
            echo "📚 强制同步wiki内容 - $(date '+%Y-%m-%d %H:%M:%S')" > commit_message.txt
            echo "" >> commit_message.txt
            echo "强制同步执行" >> commit_message.txt
            git commit --allow-empty -F commit_message.txt
            git push
            echo "✅ Wiki内容已强制同步到GitHub Wiki！"
          else
            echo "ℹ️ 没有检测到更改，无需提交"
          fi
        else
          echo "📚 从.qoder/repowiki同步wiki内容 - $(date '+%Y-%m-%d %H:%M:%S')" > commit_message.txt
          echo "" >> commit_message.txt
          echo "同步的文件:" >> commit_message.txt
          git status --porcelain | sed 's/^/- /' >> commit_message.txt
          
          git commit -F commit_message.txt
          git push
          echo "✅ Wiki内容已成功同步到GitHub Wiki！"
        fi

    - name: Create Summary
      run: |
        echo "## 🎯 Wiki同步结果" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **同步时间**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **源目录**: .qoder/repowiki/zh/content" >> $GITHUB_STEP_SUMMARY
        echo "- **目标**: GitHub Wiki" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d ".qoder/repowiki/zh/content" ]; then
          file_count=$(find .qoder/repowiki/zh/content -name "*.md" -type f | wc -l)
          echo "- **同步文件数量**: $file_count" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📄 同步的文件" >> $GITHUB_STEP_SUMMARY
          find .qoder/repowiki/zh/content -name "*.md" -type f | while read file; do
            filename=$(basename "$file")
            echo "- $filename" >> $GITHUB_STEP_SUMMARY
          done
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔗 访问链接" >> $GITHUB_STEP_SUMMARY
        echo "[📖 查看GitHub Wiki](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY