name: Manual Wiki Sync from .qoder/repowiki

on:
  workflow_dispatch:
    inputs:
      sync_type:
        description: '同步类型'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - incremental
      force_update:
        description: '强制更新所有页面'
        required: false
        default: false
        type: boolean

jobs:
  manual-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Wiki Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}.wiki
        path: wiki-repo
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Environment
      run: |
        echo "SYNC_TYPE=${{ github.event.inputs.sync_type }}" >> $GITHUB_ENV
        echo "FORCE_UPDATE=${{ github.event.inputs.force_update }}" >> $GITHUB_ENV
        echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

    - name: Clean Wiki Repository (if force update)
      if: ${{ github.event.inputs.force_update == 'true' }}
      run: |
        cd wiki-repo
        # 清空目录（保留.git）
        for file in *; do
          if [ "$file" != ".git" ] && [ -e "$file" ]; then
            rm -rf "$file"
          fi
        done
        echo "Wiki repository cleaned for force update"

    - name: Check and Sync Local Wiki Content
      run: |
        if [ -d ".qoder/repowiki/zh/content" ]; then
          echo "✅ 找到Qoder wiki内容目录: .qoder/repowiki/zh/content"
          echo "📁 目录内容:"
          ls -la .qoder/repowiki/zh/content/
          
          mkdir -p wiki-repo
          
          if [ "${{ github.event.inputs.sync_type }}" = "full" ]; then
            # 清空wiki仓库内容（保留.git目录）
            for file in wiki-repo/*; do
              if [ "$(basename "$file")" != ".git" ] && [ -e "$file" ]; then
                rm -rf "$file"
              fi
            done
            echo "🧽 已清空目标wiki仓库（全量同步模式）"
          fi
          
          cp -r .qoder/repowiki/zh/content/* wiki-repo/ 2>/dev/null || true
          echo "✅ 已将.qoder/repowiki/zh/content目录内容复制到GitHub Wiki"
          
          echo "📄 同步的文件列表:"
          find wiki-repo -name "*.md" -type f | while read file; do
            echo "  - $(basename "$file")"
          done
        else
          echo "❌ 未找到.qoder/repowiki/zh/content目录"
          echo "请在Qoder IDE中创建wiki内容"
          exit 1
        fi

    - name: Generate Project Statistics
      run: |
        cd wiki-repo
        
        echo "# 项目统计信息" > Project-Statistics.md
        echo "" >> Project-Statistics.md
        echo "## 基本信息" >> Project-Statistics.md
        echo "- **最后更新**: ${{ env.TIMESTAMP }}" >> Project-Statistics.md
        echo "- **同步类型**: ${{ env.SYNC_TYPE }}" >> Project-Statistics.md
        echo "- **强制更新**: ${{ env.FORCE_UPDATE }}" >> Project-Statistics.md
        echo "- **源目录**: .qoder/repowiki/zh/content" >> Project-Statistics.md
        echo "" >> Project-Statistics.md
        echo "## 文件统计" >> Project-Statistics.md
        
        if [ -d "../scripts" ]; then
          echo "- **Python文件数量**: $(find ../scripts -name "*.py" | wc -l)" >> Project-Statistics.md
        fi
        if [ -d "../config" ]; then
          echo "- **配置文件数量**: $(find ../config -type f 2>/dev/null | wc -l || echo 0)" >> Project-Statistics.md
        fi
        echo "- **Wiki文档数量**: $(find . -name "*.md" | wc -l)" >> Project-Statistics.md
        
        echo "" >> Project-Statistics.md
        echo "## 最近提交" >> Project-Statistics.md
        echo '```' >> Project-Statistics.md
        cd ..
        git log --oneline -5 >> wiki-repo/Project-Statistics.md
        echo '```' >> wiki-repo/Project-Statistics.md

    - name: Update Navigation
      run: |
        cd wiki-repo
        
        echo "## 📚 文档导航" > _Sidebar.md
        echo "" >> _Sidebar.md
        echo "### 🏠 主要页面" >> _Sidebar.md
        echo "- [🏠 项目主页](Home)" >> _Sidebar.md
        echo "- [📊 项目概述](项目概述)" >> _Sidebar.md
        echo "- [📖 使用方法](使用方法)" >> _Sidebar.md
        echo "- [📈 项目统计](Project-Statistics)" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "### 📄 技术文档" >> _Sidebar.md
        echo "- [🛠️ 安装与配置](安装与配置)" >> _Sidebar.md
        echo "- [🏢 架构设计](架构设计)" >> _Sidebar.md
        echo "- [🔧 系统恢复功能](系统恢复功能)" >> _Sidebar.md
        echo "- [🔍 故障排除](故障排除)" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "### 🔗 快速链接" >> _Sidebar.md
        echo "- [📦 安装说明](Usage-Guide#安装步骤)" >> _Sidebar.md
        echo "- [🛠️ 配置说明](Usage-Guide#配置说明)" >> _Sidebar.md
        echo "- [🔍 故障排除](Usage-Guide#故障排除)" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "### 🌐 外部资源" >> _Sidebar.md
        echo "- [📝 源代码](https://github.com/${{ github.repository }})" >> _Sidebar.md
        echo "- [🐛 问题反馈](https://github.com/${{ github.repository }}/issues)" >> _Sidebar.md
        echo "- [🚀 版本发布](https://github.com/${{ github.repository }}/releases)" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "---" >> _Sidebar.md
        echo "*最后更新: ${{ env.TIMESTAMP }}*" >> _Sidebar.md

    - name: Commit and Push Changes
      run: |
        cd wiki-repo
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action (Manual Sync)"
        
        git add .
        
        if git diff --staged --quiet; then
          echo "❌ 没有检测到更改，无需提交"
          echo "NO_CHANGES=true" >> $GITHUB_ENV
        else
          commit_message="📚 手动同步Wiki从Qoder IDE - ${{ env.SYNC_TYPE }} (${{ env.TIMESTAMP }})"
          git commit -m "$commit_message"
          git push
          echo "✅ Wiki同步成功！"
          echo "SYNC_SUCCESS=true" >> $GITHUB_ENV
        fi

    - name: Summary
      run: |
        echo "## 🎯 同步结果总结" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **同步时间**: ${{ env.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **同步类型**: ${{ env.SYNC_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **强制更新**: ${{ env.FORCE_UPDATE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **源目录**: .qoder/repowiki/zh/content" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ env.NO_CHANGES }}" = "true" ]; then
          echo "- **结果**: ❌ 没有检测到更改" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ env.SYNC_SUCCESS }}" = "true" ]; then
          echo "- **结果**: ✅ 同步成功" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **结果**: ⚠️ 同步状态未知" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📖 Wiki链接" >> $GITHUB_STEP_SUMMARY
        echo "访问项目Wiki: [https://github.com/${{ github.repository }}/wiki](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY