name: Manual Wiki Sync from .qoder/repowiki

on:
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'åŒæ­¥ç±»åž‹'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - incremental
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰é¡µé¢'
        required: false
        default: false
        type: boolean

jobs:
  manual-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Wiki Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}.wiki
        path: wiki-repo
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Environment
      run: |
        echo "SYNC_TYPE=${{ github.event.inputs.sync_type }}" >> $GITHUB_ENV
        echo "FORCE_UPDATE=${{ github.event.inputs.force_update }}" >> $GITHUB_ENV
        echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

    - name: Clean Wiki Repository (if force update)
      if: ${{ github.event.inputs.force_update == 'true' }}
      run: |
        cd wiki-repo
        # æ¸…ç©ºç›®å½•ï¼ˆä¿ç•™.gitï¼‰
        for file in *; do
          if [ "$file" != ".git" ] && [ -e "$file" ]; then
            rm -rf "$file"
          fi
        done
        echo "Wiki repository cleaned for force update"

    - name: Check and Sync Local Wiki Content
      run: |
        if [ -d ".qoder/repowiki/zh/content" ]; then
          echo "âœ… æ‰¾åˆ°Qoder wikiå†…å®¹ç›®å½•: .qoder/repowiki/zh/content"
          echo "ðŸ“ ç›®å½•å†…å®¹:"
          ls -la .qoder/repowiki/zh/content/
          
          mkdir -p wiki-repo
          
          if [ "${{ github.event.inputs.sync_type }}" = "full" ]; then
            # æ¸…ç©ºwikiä»“åº“å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•ï¼‰
            for file in wiki-repo/*; do
              if [ "$(basename "$file")" != ".git" ] && [ -e "$file" ]; then
                rm -rf "$file"
              fi
            done
            echo "ðŸ§½ å·²æ¸…ç©ºç›®æ ‡wikiä»“åº“ï¼ˆå…¨é‡åŒæ­¥æ¨¡å¼ï¼‰"
          fi
          
          cp -r .qoder/repowiki/zh/content/* wiki-repo/ 2>/dev/null || true
          echo "âœ… å·²å°†.qoder/repowiki/zh/contentç›®å½•å†…å®¹å¤åˆ¶åˆ°GitHub Wiki"
          
          echo "ðŸ“„ åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨:"
          find wiki-repo -name "*.md" -type f | while read file; do
            echo "  - $(basename "$file")"
          done
        else
          echo "âŒ æœªæ‰¾åˆ°.qoder/repowiki/zh/contentç›®å½•"
          echo "è¯·åœ¨Qoder IDEä¸­åˆ›å»ºwikiå†…å®¹"
          exit 1
        fi

    - name: Generate Project Statistics
      run: |
        cd wiki-repo
        
        echo "# é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯" > Project-Statistics.md
        echo "" >> Project-Statistics.md
        echo "## åŸºæœ¬ä¿¡æ¯" >> Project-Statistics.md
        echo "- **æœ€åŽæ›´æ–°**: ${{ env.TIMESTAMP }}" >> Project-Statistics.md
        echo "- **åŒæ­¥ç±»åž‹**: ${{ env.SYNC_TYPE }}" >> Project-Statistics.md
        echo "- **å¼ºåˆ¶æ›´æ–°**: ${{ env.FORCE_UPDATE }}" >> Project-Statistics.md
        echo "- **æºç›®å½•**: .qoder/repowiki/zh/content" >> Project-Statistics.md
        echo "" >> Project-Statistics.md
        echo "## æ–‡ä»¶ç»Ÿè®¡" >> Project-Statistics.md
        
        if [ -d "../scripts" ]; then
          echo "- **Pythonæ–‡ä»¶æ•°é‡**: $(find ../scripts -name "*.py" | wc -l)" >> Project-Statistics.md
        fi
        if [ -d "../config" ]; then
          echo "- **é…ç½®æ–‡ä»¶æ•°é‡**: $(find ../config -type f 2>/dev/null | wc -l || echo 0)" >> Project-Statistics.md
        fi
        echo "- **Wikiæ–‡æ¡£æ•°é‡**: $(find . -name "*.md" | wc -l)" >> Project-Statistics.md
        
        echo "" >> Project-Statistics.md
        echo "## æœ€è¿‘æäº¤" >> Project-Statistics.md
        echo '```' >> Project-Statistics.md
        cd ..
        git log --oneline -5 >> wiki-repo/Project-Statistics.md
        echo '```' >> wiki-repo/Project-Statistics.md

    - name: Update Navigation
      run: |
        cd wiki-repo
        
        echo "## ðŸ“š æ–‡æ¡£å¯¼èˆª" > _Sidebar.md
        echo "" >> _Sidebar.md
        echo "### ðŸ  ä¸»è¦é¡µé¢" >> _Sidebar.md
        echo "- [ðŸ  é¡¹ç›®ä¸»é¡µ](Home)" >> _Sidebar.md
        echo "- [ðŸ“Š é¡¹ç›®æ¦‚è¿°](é¡¹ç›®æ¦‚è¿°)" >> _Sidebar.md
        echo "- [ðŸ“– ä½¿ç”¨æ–¹æ³•](ä½¿ç”¨æ–¹æ³•)" >> _Sidebar.md
        echo "- [ðŸ“ˆ é¡¹ç›®ç»Ÿè®¡](Project-Statistics)" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "### ðŸ“„ æŠ€æœ¯æ–‡æ¡£" >> _Sidebar.md
        echo "- [ðŸ› ï¸ å®‰è£…ä¸Žé…ç½®](å®‰è£…ä¸Žé…ç½®)" >> _Sidebar.md
        echo "- [ðŸ¢ æž¶æž„è®¾è®¡](æž¶æž„è®¾è®¡)" >> _Sidebar.md
        echo "- [ðŸ”§ ç³»ç»Ÿæ¢å¤åŠŸèƒ½](ç³»ç»Ÿæ¢å¤åŠŸèƒ½)" >> _Sidebar.md
        echo "- [ðŸ” æ•…éšœæŽ’é™¤](æ•…éšœæŽ’é™¤)" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "### ðŸ”— å¿«é€Ÿé“¾æŽ¥" >> _Sidebar.md
        echo "- [ðŸ“¦ å®‰è£…è¯´æ˜Ž](Usage-Guide#å®‰è£…æ­¥éª¤)" >> _Sidebar.md
        echo "- [ðŸ› ï¸ é…ç½®è¯´æ˜Ž](Usage-Guide#é…ç½®è¯´æ˜Ž)" >> _Sidebar.md
        echo "- [ðŸ” æ•…éšœæŽ’é™¤](Usage-Guide#æ•…éšœæŽ’é™¤)" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "### ðŸŒ å¤–éƒ¨èµ„æº" >> _Sidebar.md
        echo "- [ðŸ“ æºä»£ç ](https://github.com/${{ github.repository }})" >> _Sidebar.md
        echo "- [ðŸ› é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)" >> _Sidebar.md
        echo "- [ðŸš€ ç‰ˆæœ¬å‘å¸ƒ](https://github.com/${{ github.repository }}/releases)" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "---" >> _Sidebar.md
        echo "*æœ€åŽæ›´æ–°: ${{ env.TIMESTAMP }}*" >> _Sidebar.md

    - name: Commit and Push Changes
      run: |
        cd wiki-repo
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action (Manual Sync)"
        
        git add .
        
        if git diff --staged --quiet; then
          echo "âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œæ— éœ€æäº¤"
          echo "NO_CHANGES=true" >> $GITHUB_ENV
        else
          commit_message="ðŸ“š æ‰‹åŠ¨åŒæ­¥Wikiä»ŽQoder IDE - ${{ env.SYNC_TYPE }} (${{ env.TIMESTAMP }})"
          git commit -m "$commit_message"
          git push
          echo "âœ… WikiåŒæ­¥æˆåŠŸï¼"
          echo "SYNC_SUCCESS=true" >> $GITHUB_ENV
        fi

    - name: Summary
      run: |
        echo "## ðŸŽ¯ åŒæ­¥ç»“æžœæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒæ­¥æ—¶é—´**: ${{ env.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒæ­¥ç±»åž‹**: ${{ env.SYNC_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¼ºåˆ¶æ›´æ–°**: ${{ env.FORCE_UPDATE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æºç›®å½•**: .qoder/repowiki/zh/content" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ env.NO_CHANGES }}" = "true" ]; then
          echo "- **ç»“æžœ**: âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ env.SYNC_SUCCESS }}" = "true" ]; then
          echo "- **ç»“æžœ**: âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **ç»“æžœ**: âš ï¸ åŒæ­¥çŠ¶æ€æœªçŸ¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“– Wikié“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "è®¿é—®é¡¹ç›®Wiki: [https://github.com/${{ github.repository }}/wiki](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY