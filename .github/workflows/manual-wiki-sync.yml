name: Manual Wiki Sync

on:
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'åŒæ­¥ç±»åž‹'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - incremental
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰é¡µé¢'
        required: false
        default: false
        type: boolean

jobs:
  manual-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Wiki Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}.wiki
        path: wiki-repo
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Environment
      run: |
        echo "SYNC_TYPE=${{ github.event.inputs.sync_type }}" >> $GITHUB_ENV
        echo "FORCE_UPDATE=${{ github.event.inputs.force_update }}" >> $GITHUB_ENV
        echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

    - name: Clean Wiki Repository (if force update)
      if: ${{ github.event.inputs.force_update == 'true' }}
      run: |
        cd wiki-repo
        # ä¿ç•™ .git ç›®å½•ï¼Œåˆ é™¤å…¶ä»–æ‰€æœ‰æ–‡ä»¶
        find . -name ".git" -prune -o -type f -exec rm {} \;
        echo "Wiki repository cleaned for force update"

name: Manual Wiki Sync from .qoder/repowiki

on:
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'åŒæ­¥ç±»åž‹'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - incremental
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰é¡µé¢'
        required: false
        default: false
        type: boolean

jobs:
  manual-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Wiki Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}.wiki
        path: wiki-repo
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Environment
      run: |
        echo "SYNC_TYPE=${{ github.event.inputs.sync_type }}" >> $GITHUB_ENV
        echo "FORCE_UPDATE=${{ github.event.inputs.force_update }}" >> $GITHUB_ENV
        echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

    - name: Clean Wiki Repository (if force update)
      if: ${{ github.event.inputs.force_update == 'true' }}
      run: |
        cd wiki-repo
        # ä¿ç•™ .git ç›®å½•ï¼Œåˆ é™¤å…¶ä»–æ‰€æœ‰æ–‡ä»¶
        find . -name ".git" -prune -o -type f -exec rm {} \;
        echo "Wiki repository cleaned for force update"

    - name: Check and Sync Local Wiki Content
      run: |
        if [ -d ".qoder/repowiki" ]; then
          echo "âœ… æ‰¾åˆ°æœ¬åœ°wikiç›®å½•: .qoder/repowiki"
          echo "ðŸ“ ç›®å½•å†…å®¹:"
          ls -la .qoder/repowiki/
          
          # ç¡®ä¿wikiä»“åº“ç›®å½•å­˜åœ¨
          mkdir -p wiki-repo
          
          # æ¸…ç©ºwikiä»“åº“å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•ï¼‰
          if [ "${{ github.event.inputs.sync_type }}" = "full" ]; then
            find wiki-repo -mindepth 1 -name ".git" -prune -o -type f -delete
            echo "ðŸ§½ å·²æ¸…ç©ºç›®æ ‡wikiä»“åº“ï¼ˆå…¨é‡åŒæ­¥æ¨¡å¼ï¼‰"
          fi
          
          # å¤åˆ¶.qoder/repowikiç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹åˆ°wikiä»“åº“
          cp -r .qoder/repowiki/* wiki-repo/ 2>/dev/null || true
          echo "âœ… å·²å°†.qoder/repowikiç›®å½•å†…å®¹å¤åˆ¶åˆ°GitHub Wiki"
          
          # æ˜¾ç¤ºå¤åˆ¶çš„æ–‡ä»¶
          echo "ðŸ“„ åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨:"
          find wiki-repo -name "*.md" -type f | while read file; do
            echo "  - $(basename "$file")"
          done
        else
          echo "âŒ æœªæ‰¾åˆ°.qoder/repowikiç›®å½•"
          echo "åˆ›å»ºç¤ºä¾‹wikiç›®å½•å’Œå†…å®¹..."
          mkdir -p .qoder/repowiki
          
          # åˆ›å»ºç¤ºä¾‹Homeé¡µé¢
          cat > .qoder/repowiki/Home.md << 'EOF'
# CloudResourceOptimizer

æ¬¢è¿Žä½¿ç”¨CloudResourceOptimizerï¼

## å¿«é€Ÿå¯¼èˆª
- [é¡¹ç›®æ¦‚è¿°](Project-Overview)
- [ä½¿ç”¨æŒ‡å—](Usage-Guide)
- [APIæ–‡æ¡£](API-Documentation)
- [é…ç½®æŒ‡å—](Configuration-Guide)

---
*æ­¤é¡µé¢ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*
EOF
          
          # åˆ›å»ºç¤ºä¾‹é¡¹ç›®æ¦‚è¿°
          cat > .qoder/repowiki/Project-Overview.md << 'EOF'
# é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªCloudResourceOptimizeré¡¹ç›®ã€‚

## ä¸»è¦åŠŸèƒ½
- ç³»ç»Ÿç›‘æŽ§
- æ•…éšœæ¢å¤
- åŽ‹åŠ›æµ‹è¯•

---
*è¯·åœ¨.qoder/repowikiç›®å½•ä¸‹åˆ›å»ºæ‚¨è‡ªå·±çš„wikiå†…å®¹*
EOF
          
          # åŒæ­¥ç¤ºä¾‹å†…å®¹åˆ°wikiä»“åº“
          cp -r .qoder/repowiki/* wiki-repo/ 2>/dev/null || true
          echo "â„¹ï¸ å·²åˆ›å»ºç¤ºä¾‹wikiå†…å®¹å¹¶åŒæ­¥åˆ°GitHub Wiki"
        fi

    - name: Generate Project Statistics
      run: |
        cd wiki-repo
        
        # ç”Ÿæˆé¡¹ç›®ç»Ÿè®¡ä¿¡æ¯
        cat > Project-Statistics.md << 'EOF'
        # é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯

        ## åŸºæœ¬ä¿¡æ¯
        - **æœ€åŽæ›´æ–°**: ${{ env.TIMESTAMP }}
        - **åŒæ­¥ç±»åž‹**: ${{ env.SYNC_TYPE }}
        - **å¼ºåˆ¶æ›´æ–°**: ${{ env.FORCE_UPDATE }}
        - **æºç›®å½•**: .qoder/repowiki

        ## æ–‡ä»¶ç»Ÿè®¡
        EOF
        
        # æ·»åŠ æ–‡ä»¶ç»Ÿè®¡
        if [ -d "../scripts" ]; then
          echo "- **Pythonæ–‡ä»¶æ•°é‡**: $(find ../scripts -name "*.py" | wc -l)" >> Project-Statistics.md
        fi
        if [ -d "../config" ]; then
          echo "- **é…ç½®æ–‡ä»¶æ•°é‡**: $(find ../config -type f 2>/dev/null | wc -l || echo 0)" >> Project-Statistics.md
        fi
        echo "- **Wikiæ–‡æ¡£æ•°é‡**: $(find . -name "*.md" | wc -l)" >> Project-Statistics.md
        
        # æ·»åŠ æœ€è¿‘æäº¤ä¿¡æ¯
        echo "" >> Project-Statistics.md
        echo "## æœ€è¿‘æäº¤" >> Project-Statistics.md
        echo '```' >> Project-Statistics.md
        cd ..
        git log --oneline -5 >> wiki-repo/Project-Statistics.md
        echo '```' >> wiki-repo/Project-Statistics.md

    - name: Update Navigation
      run: |
        cd wiki-repo
        
        # ç”ŸæˆåŠ¨æ€å¯¼èˆª
        cat > _Sidebar.md << 'EOF'
        ## ðŸ“š æ–‡æ¡£å¯¼èˆª

        ### ðŸ  ä¸»è¦é¡µé¢
        - [ðŸ  é¡¹ç›®ä¸»é¡µ](Home)
        - [ðŸ“Š é¡¹ç›®æ¦‚è¿°](Project-Overview)
        - [ðŸ“– ä½¿ç”¨æŒ‡å—](Usage-Guide)
        - [ðŸ“ˆ é¡¹ç›®ç»Ÿè®¡](Project-Statistics)

        ### ðŸ“„ æŠ€æœ¯æ–‡æ¡£
        - [ðŸ”§ APIæ–‡æ¡£](API-Documentation)
        - [âš™ï¸ é…ç½®æŒ‡å—](Configuration-Guide)
        - [ðŸ“ˆ é¡¹ç›®ç»Ÿè®¡](Project-Statistics)

        ### ðŸ”— å¿«é€Ÿé“¾æŽ¥
        - [ðŸ“¦ å®‰è£…è¯´æ˜Ž](Usage-Guide#å®‰è£…æ­¥éª¤)
        - [ðŸ› ï¸ é…ç½®è¯´æ˜Ž](Usage-Guide#é…ç½®è¯´æ˜Ž)
        - [ðŸ” æ•…éšœæŽ’é™¤](Usage-Guide#æ•…éšœæŽ’é™¤)

        ### ðŸŒ å¤–éƒ¨èµ„æº
        - [ðŸ“ æºä»£ç ](https://github.com/${{ github.repository }})
        - [ðŸ› é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
        - [ðŸš€ ç‰ˆæœ¬å‘å¸ƒ](https://github.com/${{ github.repository }}/releases)
        
        ---
        *æœ€åŽæ›´æ–°: ${{ env.TIMESTAMP }}*
        EOF

    - name: Commit and Push Changes
      run: |
        cd wiki-repo
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action (Manual Sync)"
        
        git add .
        
        if git diff --staged --quiet; then
          echo "âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œæ— éœ€æäº¤"
          echo "NO_CHANGES=true" >> $GITHUB_ENV
        else
          commit_message="ðŸ“š æ‰‹åŠ¨åŒæ­¥Wikiä»Ž.qoder/repowiki - ${{ env.SYNC_TYPE }} (${{ env.TIMESTAMP }})"
          git commit -m "$commit_message"
          git push
          echo "âœ… WikiåŒæ­¥æˆåŠŸï¼"
          echo "SYNC_SUCCESS=true" >> $GITHUB_ENV
        fi

    - name: Summary
      run: |
        echo "## ðŸŽ¯ åŒæ­¥ç»“æžœæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒæ­¥æ—¶é—´**: ${{ env.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒæ­¥ç±»åž‹**: ${{ env.SYNC_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¼ºåˆ¶æ›´æ–°**: ${{ env.FORCE_UPDATE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æºç›®å½•**: .qoder/repowiki" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ env.NO_CHANGES }}" = "true" ]; then
          echo "- **ç»“æžœ**: âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ env.SYNC_SUCCESS }}" = "true" ]; then
          echo "- **ç»“æžœ**: âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **ç»“æžœ**: âš ï¸ åŒæ­¥çŠ¶æ€æœªçŸ¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“– Wikié“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "è®¿é—®é¡¹ç›®Wiki: [https://github.com/${{ github.repository }}/wiki](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY